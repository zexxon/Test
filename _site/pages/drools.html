

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Message rewriting with Drools &mdash; Graylog 1.2.0 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="Graylog 1.2.0 documentation" href="../index.html"/>
        <link rel="next" title="Blacklisting" href="blacklisting.html"/>
        <link rel="prev" title="Extractors" href="extractors.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> Graylog
          

          
          </a>

          
            
            
              <div class="version">
                1.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="architecture.html">Architectural considerations</a></li>
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installing Graylog</a></li>
<li class="toctree-l1"><a class="reference internal" href="configuring_es.html">Configuring and tuning Elasticsearch</a></li>
<li class="toctree-l1"><a class="reference internal" href="sending_data.html">Sending in log data</a></li>
<li class="toctree-l1"><a class="reference internal" href="collector.html">Graylog Collector</a></li>
<li class="toctree-l1"><a class="reference internal" href="queries.html">Searching</a></li>
<li class="toctree-l1"><a class="reference internal" href="streams.html">Streams</a></li>
<li class="toctree-l1"><a class="reference internal" href="dashboards.html">Dashboards</a></li>
<li class="toctree-l1"><a class="reference internal" href="extractors.html">Extractors</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="">Message rewriting with Drools</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#getting-started">Getting Started</a></li>
<li class="toctree-l2"><a class="reference internal" href="#example-rules-file">Example rules file</a></li>
<li class="toctree-l2"><a class="reference internal" href="#parsing-message-and-adding-fields">Parsing Message and adding fields</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#another-example-adding-additional-fields-and-changing-the-message-itself">Another example: Adding additional fields and changing the message itself</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#blacklisting-messages">Blacklisting messages</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="blacklisting.html">Blacklisting</a></li>
<li class="toctree-l1"><a class="reference internal" href="load_balancers.html">Load balancer integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="index_model.html">The Graylog index model explained</a></li>
<li class="toctree-l1"><a class="reference internal" href="indexer_failures.html">Indexer failures and dead letters</a></li>
<li class="toctree-l1"><a class="reference internal" href="users_and_roles.html">Users and Roles</a></li>
<li class="toctree-l1"><a class="reference internal" href="plugins.html">Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="external_dashboards.html">External dashboards</a></li>
<li class="toctree-l1"><a class="reference internal" href="marketplace.html">Graylog Marketplace</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">Frequently asked questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="ideas_explained.html">The thinking behind the Graylog architecture and why it matters to you</a></li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changelog</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">Graylog</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
    <li>Message rewriting with Drools</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/pages/drools.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="message-rewriting-with-drools">
<span id="drools"></span><h1>Message rewriting with Drools<a class="headerlink" href="#message-rewriting-with-drools" title="Permalink to this headline">¶</a></h1>
<p>Graylog can optionally use <a class="reference external" href="http://www.jboss.org/drools/drools-expert">Drools Expert</a> to evaluate all incoming messages against a user defined
rules file. Each message will be evaluated prior to being written to the outputs.</p>
<p>The rule file location is defined in the Graylog configuration file:</p>
<div class="highlight-python"><div class="highlight"><pre># Drools Rule File (Use to rewrite incoming log messages)
rules_file = /etc/graylog.d/rules/graylog.drl
</pre></div>
</div>
<p>The rules file is located on the file system with a <code class="docutils literal"><span class="pre">.drl</span></code> file extension. The rules file can contain multiple rules, queries and functions,
as well as some resource declarations like imports, globals, and attributes that are assigned and used by your rules and queries.</p>
<p>For more information on the DRL rules syntax please read the <a class="reference external" href="http://docs.jboss.org/drools/release/5.5.0.Final/drools-expert-docs/html/ch04.html">Drools User Guide</a>.</p>
<div class="section" id="getting-started">
<h2>Getting Started<a class="headerlink" href="#getting-started" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><ol class="arabic simple">
<li>Uncomment the <code class="docutils literal"><span class="pre">rules_file</span></code> line in the Graylog configuration file.</li>
<li>Copy the <a class="reference external" href="https://github.com/Graylog2/graylog2-server/blob/1.2/misc/graylog2.drl">sample rules file</a> to the location specified in your Graylog configuration file.</li>
<li>Modify the rules file to parse/rewrite/filter messages as needed.</li>
</ol>
</div></blockquote>
</div>
<div class="section" id="example-rules-file">
<h2>Example rules file<a class="headerlink" href="#example-rules-file" title="Permalink to this headline">¶</a></h2>
<p>This is an example rules file:</p>
<div class="highlight-python"><div class="highlight"><pre>import org.graylog2.plugin.Message

rule &quot;Rewrite localhost host&quot;
    when
        m : Message( source == &quot;localhost&quot; )
    then
        m.addField(&quot;source&quot;, &quot;localhost.example.com&quot; );
        System.out.println( &quot;[Overwrite localhost rule fired] : &quot; + m.toString() );
end

rule &quot;Drop UDP and ICMP Traffic from firewall&quot;
    when
        m : Message( getField(&quot;full_message&quot;) matches &quot;(?i).*(ICMP|UDP) Packet(.|\n|\r)*&quot; &amp;&amp; source == &quot;firewall&quot; )
    then
        m.setFilterOut(true);
        System.out.println(&quot;[Drop all syslog ICMP and UDP traffic] : &quot; + m.toString() );
end
</pre></div>
</div>
</div>
<div class="section" id="parsing-message-and-adding-fields">
<h2>Parsing Message and adding fields<a class="headerlink" href="#parsing-message-and-adding-fields" title="Permalink to this headline">¶</a></h2>
<p>In the following script we turn the PID and the src IP into additional fields:</p>
<div class="highlight-python"><div class="highlight"><pre>import org.graylog2.plugin.Message
import java.util.regex.Matcher
import java.util.regex.Pattern

// Raw Syslog Apr 18 15:34:58 server01 smtp-glass[3371]: NEW (1/0) on=1.1.1.1:9100, src=2.2.2.2:38776, ident=, dst=3.3.3.3:25, id=1303151698.3371
rule &quot;SMTP Glass Logging to GELF&quot;
  when
      m : Message( message matches &quot;^smtp-glass.*&quot; )
  then
      Matcher matcher = Pattern.compile(&quot;smtp-glass\\\[(\\\d+)].* src (\\\d+.\\\d+.\\\d+.\\\d+)&quot;).matcher(m.getMessage());
      if (matcher.find()) {
         m.addField(&quot;_pid&quot;, Long.valueOf(matcher.group(1)));
         m.addField(&quot;_src&quot;, matcher.group(2));
      }
end
</pre></div>
</div>
<div class="section" id="another-example-adding-additional-fields-and-changing-the-message-itself">
<h3>Another example: Adding additional fields and changing the message itself<a class="headerlink" href="#another-example-adding-additional-fields-and-changing-the-message-itself" title="Permalink to this headline">¶</a></h3>
<p>We send Squid access logs to Graylog using Syslog. The problem is that the <em>host</em> field of the message was set to the
IP addrress of the Squid proxy, which not very useful. This rule overwrites the source and adds other fields:</p>
<div class="highlight-python"><div class="highlight"><pre>import org.graylog2.plugin.Message
import java.util.regex.Matcher
import java.util.regex.Pattern
import java.net.InetAddress;

/*
Raw Syslog: squid[2099]: 1339551529.881  55647 1.2.3.4 TCP_MISS/200 22 GET http://www.google.com/

squid\[\d+\]: (\d+\.\d+) *(\d+) *(\d+.\d+.\d+.\d+) *(\w+\/\w+) (\d+) (\w+) (.*)
matched: 13:1339551529.881
matched: 29:55647
matched: 35:1.2.3.4
matched: 47:TCP_MISS/200
matched: 60:22
matched: 64:GET
matched: 68:http://www.google.com/
*/

rule &quot;Squid Logging to GELF&quot;
    when
        m : Message( getField(&quot;facility&quot;) == &quot;local5&quot; )
    then
        Matcher matcher = Pattern.compile(&quot;squid\\[\\d+\\]: (\\d+.\\d+) *(\\d+) *(\\d+.\\d+.\\d+.\\d+) *(\\w+\\/\\w+) (\\d+) (\\w+) (.*)&quot;).matcher(m.getMessage());

        if (matcher.find()) {
            m.addField(&quot;facility&quot;, &quot;squid&quot;);
            InetAddress addr = InetAddress.getByName(matcher.group(3));
            String host = addr.getHostName();
            m.addField(&quot;source&quot;,host);
            m.addField(&quot;message&quot;,matcher.group(6) + &quot; &quot; + matcher.group(7));
            m.addField(&quot;_status&quot;,matcher.group(4));
            m.addField(&quot;_size&quot;,matcher.group(5));
        }
end
</pre></div>
</div>
</div>
</div>
<div class="section" id="blacklisting-messages">
<h2>Blacklisting messages<a class="headerlink" href="#blacklisting-messages" title="Permalink to this headline">¶</a></h2>
<p>You can also use Drools rules to blacklist messages. How to do this is described <a class="reference internal" href="blacklisting.html#blacklisting"><span>here</span></a>.</p>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="blacklisting.html" class="btn btn-neutral float-right" title="Blacklisting" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="extractors.html" class="btn btn-neutral" title="Extractors" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015 Graylog, Inc..

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1.2.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>